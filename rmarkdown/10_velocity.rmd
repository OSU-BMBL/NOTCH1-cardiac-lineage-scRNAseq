---
title: "RNA Velocity"
author: "Cankun Wang"
date: "`r format(Sys.time(), '%m/%d/%Y')`"
output: 
  html_document:
    toc: true
    toc_float: true
    number_sections: true
    df_print: paged
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(Seurat)
library(here)
library(qs)
library(SeuratWrappers)
library(tidyverse)
library(SeuratDisk)
#library(cowplot)
#library(dplyr)
#library(ggplot2)
#library(patchwork)
```


# Set working dir

```{r,echo=F,eval=T,message=F,warning=F,error=F}
here::i_am("10_velocity.rmd")
here::set_here()
print(paste("Current working directory:", here::here()))

```

# Load data

```{r,echo=F,eval=T,message=F,warning=F,error=F}
source("functions.R")

combined <- qs::qread('combined.qsave')

#custom_color <- as.character(palette36.colors(36)[-2])[1:length(levels(Idents(combined)))]

two_color <- c('#C0C0C0', '#B00D23')

Idents(combined) <- combined$orig.ident
DefaultAssay(combined) <- "RNA"

dir.create('../velocity_h5ad')
RESULT_DIR <- "../velocity_h5ad/"

i = 1
j = 1
k = 1
idx = 1

sample_list <- read.csv("../sample_list.csv")
sample_list
```



```{r}
i = 11
for (i in seq_len(nrow(sample_list))) {
  this_sample <- sample_list$sample[i]
  this_sample_name <- sample_list$id[i]
  #sub_combined <- subset(combined, idents = this_sample)
  
  sub_combined <- qread(paste0("../sample_obj/",this_sample,".qsave"))
  loom_filename <-
    paste0("../velocity_loom/", this_sample_name, ".loom")
  loom_obj <- read.loom.matrices(file = loom_filename)
  loom_seurat_obj <- as.Seurat(x = loom_obj)
  
  # Rename cell names in velocity matrix
  col_velo <-
    str_split_fixed(colnames(loom_seurat_obj), ":", 2)[, 2]
  col_velo <- str_replace_all(col_velo, "x", "-1")
  col_velo <- paste0(this_sample, "_", col_velo)
  
  velo_cell_exist_in_RNA <-
    which(col_velo %in% colnames(sub_combined))
  
  col_velo <- col_velo[velo_cell_exist_in_RNA]
  
  loom_obj$spliced <- loom_obj$spliced[, velo_cell_exist_in_RNA]
  loom_obj$unspliced <- loom_obj$unspliced[, velo_cell_exist_in_RNA]
  loom_obj$ambiguous <- loom_obj$ambiguous[, velo_cell_exist_in_RNA]
  
  loom_obj$spliced <- loom_obj$spliced[, order(col_velo)]
  loom_obj$unspliced <- loom_obj$unspliced[, order(col_velo)]
  loom_obj$ambiguous <- loom_obj$ambiguous[, order(col_velo)]
  col_velo <- col_velo[order(col_velo)]
  
  bm <- as.Seurat(x = loom_obj)
  bm <- RenameCells(bm, new.names = col_velo)
  
  bm[["RNA"]] <- bm[["spliced"]]
  #DefaultAssay(bm) <- "RNA"
  bm <- NormalizeData(bm)
  bm <- FindVariableFeatures(bm)
  bm <- ScaleData(bm)
  bm <- RunPCA(bm)
  bm <- RunUMAP(bm, dims = 1:20)
  bm <- FindNeighbors(bm, dims = 1:20)
  #bm <- FindClusters(bm, resolution = 0.2)
  DefaultAssay(bm) <- "RNA"
  
  # Use original UMAP corrdinates
  
  bm@reductions$umap@cell.embeddings <-
    sub_combined@reductions$umap@cell.embeddings
  bm@meta.data <- cbind(bm@meta.data, sub_combined@meta.data)
  SaveH5Seurat(bm, filename = paste0(RESULT_DIR, this_sample, ".h5Seurat"))
  Convert(paste0(RESULT_DIR, this_sample, ".h5Seurat"), dest = "h5ad")
  
}


```


# Import Velocity data from loom file

```{r}
this_sample <- "N1KO14"


```

```{r}
dir.create('result')
dir.create('result/subpopulation')

Idents(combined) <- combined$orig.ident
DefaultAssay(combined) <- "RNA"

# seq_along(levels(provided_marker$cell_type))
day <- days[[11]]
for (day in days) {
  RESULT_DIR <-
    paste0("./result/subpopulation/",
           day,
           "/")
  dir.create(RESULT_DIR)
  dir.create(paste0(RESULT_DIR, "/umap"))
  dir.create(paste0(RESULT_DIR, "/marker"))
  
  Idents(combined) <- combined$orig.ident
  
  
  sub_combined <- subset(combined, idents = day)
  #Idents(sub_combined) <- sub_combined$orig.ident
  #
  #DefaultAssay(sub_combined) <- "integrated"
  #sub_combined <- RunPCA(sub_combined, npcs = 20, verbose = FALSE)
  #sub_combined <-
  #  RunUMAP(sub_combined, reduction = "pca", dims = 1:10)
  #sub_combined <-
  #  FindNeighbors(sub_combined, reduction = "pca", dims = 1:10)
  #sub_combined <- FindClusters(sub_combined, resolution = 0.2)
  #DefaultAssay(sub_combined) <- "RNA"

}
```



# Plots

```{r}


bm@reductions$umap@cell.embeddings <- sub_combined@reductions$umap@cell.embeddings
bm@meta.data <- cbind(bm@meta.data, sub_combined@meta.data)
SaveH5Seurat(bm, filename = paste0(this_sample, ".h5Seurat"))
Convert(paste0(this_sample, ".h5Seurat"), dest = "h5ad")
colnames(bm@meta.data)


for (i in seq_along(provided_marker$gene)) {
    this_gene <- provided_marker$gene[i]
    this_ct <- as.character(provided_marker$cell_type[i])
    p1 <-
      FeaturePlot(bm,
                  this_gene,
                  pt.size = 0.4,
                  cols = two_color,
                  reduction = "umap",
                  keep.scale = "all")
    
    png(
      paste(
        "./result/velocity/",this_sample,"_",
        this_gene,
        "_",
        this_ct,
        "_velocity.png",
        sep = ""
      ),
      width = 2000,
      height = 1800,
      res = 300
    )
    print(p1)
    dev.off()
  }

```

# Export to AnnData


```{r,echo=F,eval=F,message=FALSE,warning=F}
DefaultAssay(sub_combined) <- "integrated"
transfer.anchors <- FindTransferAnchors(reference = sub_combined, query = bm, features = VariableFeatures(object = sub_combined),
    reference.assay = "RNA", query.assay = "spliced", reduction = "cca")

```





